#!/usr/bin/env python3
"""
QA Sync Notion Dashboard
- QA ì§„í–‰ í˜„í™© ëŒ€ì‹œë³´ë“œ ìë™ ìƒì„±/ì—…ë°ì´íŠ¸
- ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œìœ¨, ì´ìŠˆ í˜„í™© ì‹œê°í™”
- Claude Code Notion MCPì™€ ì—°ë™
"""

import json
import sys
from datetime import datetime
from pathlib import Path
from typing import Optional

# ìƒíƒœ ê´€ë¦¬ì ì„í¬íŠ¸
sys.path.insert(0, str(Path(__file__).parent))
from state_manager import get_project, get_project_stats, list_projects, load_state


def generate_dashboard_markdown(project_name: str) -> str:
    """í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ ë§ˆí¬ë‹¤ìš´ ìƒì„±"""
    project = get_project(project_name)

    if not project:
        return f"# âŒ Project '{project_name}' not found"

    stats = project.get("stats", {})
    config = project.get("config", {})
    scenarios = project.get("scenarios", [])
    issues = project.get("issues_created", [])

    # ì§„í–‰ë¥  ê³„ì‚°
    total_scenarios = stats.get("total_scenarios", 0)
    completed_scenarios = stats.get("completed_scenarios", 0)
    progress_pct = (completed_scenarios / total_scenarios * 100) if total_scenarios > 0 else 0

    # í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±
    progress_filled = int(progress_pct / 10)
    progress_bar = "â–ˆ" * progress_filled + "â–‘" * (10 - progress_filled)

    # ì´ìŠˆ í†µê³„
    total_issues = stats.get("total_issues", 0)
    bugs = stats.get("bugs", 0)
    improvements = stats.get("improvements", 0)
    data_errors = stats.get("data_errors", 0)

    # ìµœê·¼ ì´ìŠˆ (ìµœê·¼ 5ê°œ)
    recent_issues = sorted(issues, key=lambda x: x.get("created_at", ""), reverse=True)[:5]

    md = f"""# ğŸ¯ QA Dashboard: {project_name}

> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}

---

## ğŸ“Š ìš”ì•½

| í•­ëª© | ê°’ |
|------|-----|
| ì‚¬ì´íŠ¸ | {config.get('site_url', 'N/A')} |
| Slack ì±„ë„ | {config.get('slack_channel', 'N/A')} |
| Linear í”„ë¡œì íŠ¸ | {config.get('linear_project_url', 'N/A')} |

---

## ğŸƒ ì‹œë‚˜ë¦¬ì˜¤ ì§„í–‰ë¥ 

```
{progress_bar} {progress_pct:.0f}%
```

**{completed_scenarios} / {total_scenarios}** ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ

---

## ğŸ› ì´ìŠˆ í˜„í™©

| ìœ í˜• | ê°œìˆ˜ | ë¹„ìœ¨ |
|------|------|------|
| ğŸ› ë²„ê·¸ | {bugs} | {bugs/total_issues*100:.0f}% |
| ğŸ’¡ ê°œì„  | {improvements} | {improvements/total_issues*100:.0f}% |
| ğŸ“Š ë°ì´í„° | {data_errors} | {data_errors/total_issues*100:.0f}% |
| **í•©ê³„** | **{total_issues}** | 100% |

""" if total_issues > 0 else f"""# ğŸ¯ QA Dashboard: {project_name}

> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}

---

## ğŸ“Š ìš”ì•½

| í•­ëª© | ê°’ |
|------|-----|
| ì‚¬ì´íŠ¸ | {config.get('site_url', 'N/A')} |
| Slack ì±„ë„ | {config.get('slack_channel', 'N/A')} |
| Linear í”„ë¡œì íŠ¸ | {config.get('linear_project_url', 'N/A')} |

---

## ğŸƒ ì‹œë‚˜ë¦¬ì˜¤ ì§„í–‰ë¥ 

```
{progress_bar} {progress_pct:.0f}%
```

**{completed_scenarios} / {total_scenarios}** ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ

---

## ğŸ› ì´ìŠˆ í˜„í™©

ì•„ì§ ë“±ë¡ëœ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.

"""

    # ìµœê·¼ ì´ìŠˆ ì„¹ì…˜ ì¶”ê°€
    if recent_issues:
        md += "---\n\n## ğŸ“‹ ìµœê·¼ ì´ìŠˆ\n\n"
        md += "| ì‹œê°„ | ìœ í˜• | ID |\n|------|------|----|\n"
        for issue in recent_issues:
            created = issue.get("created_at", "")[:16].replace("T", " ")
            issue_type = {"bug": "ğŸ›", "improvement": "ğŸ’¡", "data_error": "ğŸ“Š"}.get(issue.get("issue_type"), "â“")
            md += f"| {created} | {issue_type} | {issue.get('issue_id', 'N/A')} |\n"

    # ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ (ë¯¸ì™„ë£Œ ìš°ì„ )
    if scenarios:
        incomplete = [s for s in scenarios if not s.get("completed", False)]
        complete = [s for s in scenarios if s.get("completed", False)]

        md += "\n---\n\n## ğŸ“ ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡\n\n"

        if incomplete:
            md += "### â³ ë¯¸ì™„ë£Œ\n\n"
            md += "| # | ìœ í˜• | ì‹œë‚˜ë¦¬ì˜¤ | í™•ì¸ ì‚¬í•­ |\n|---|------|---------|----------|\n"
            for i, s in enumerate(incomplete[:10], 1):
                md += f"| {i} | {s.get('type', '')} | {s.get('scenario', '')[:30]} | {s.get('check', '')[:30]} |\n"
            if len(incomplete) > 10:
                md += f"\n... ì™¸ {len(incomplete) - 10}ê°œ\n"

        if complete:
            md += "\n### âœ… ì™„ë£Œ\n\n"
            md += "| # | ìœ í˜• | ì‹œë‚˜ë¦¬ì˜¤ | ì™„ë£Œì¼ |\n|---|------|---------|--------|\n"
            for i, s in enumerate(complete[:5], 1):
                completed_at = s.get("completed_at", "")[:10]
                md += f"| {i} | {s.get('type', '')} | {s.get('scenario', '')[:30]} | {completed_at} |\n"
            if len(complete) > 5:
                md += f"\n... ì™¸ {len(complete) - 5}ê°œ\n"

    md += "\n---\n\n*Generated by QA Sync*"

    return md


def generate_summary_dashboard() -> str:
    """ì „ì²´ í”„ë¡œì íŠ¸ ìš”ì•½ ëŒ€ì‹œë³´ë“œ"""
    state = load_state()
    projects = state.get("projects", {})

    if not projects:
        return "# QA Dashboard\n\ní”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."

    md = f"""# ğŸ¯ QA Dashboard

> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.now().strftime('%Y-%m-%d %H:%M')}

---

## ğŸ“Š í”„ë¡œì íŠ¸ í˜„í™©

| í”„ë¡œì íŠ¸ | ì‹œë‚˜ë¦¬ì˜¤ | ì´ìŠˆ | ë²„ê·¸ | ê°œì„  | ë°ì´í„° |
|----------|----------|------|------|------|--------|
"""

    total_scenarios = 0
    total_issues = 0

    for name, project in projects.items():
        stats = project.get("stats", {})
        scenarios = f"{stats.get('completed_scenarios', 0)}/{stats.get('total_scenarios', 0)}"
        issues = stats.get("total_issues", 0)
        bugs = stats.get("bugs", 0)
        improvements = stats.get("improvements", 0)
        data_errors = stats.get("data_errors", 0)

        md += f"| {name} | {scenarios} | {issues} | {bugs} | {improvements} | {data_errors} |\n"

        total_scenarios += stats.get("total_scenarios", 0)
        total_issues += issues

    md += f"\n**ì „ì²´: {len(projects)}ê°œ í”„ë¡œì íŠ¸, {total_scenarios}ê°œ ì‹œë‚˜ë¦¬ì˜¤, {total_issues}ê°œ ì´ìŠˆ**\n"

    md += "\n---\n\n*Generated by QA Sync*"

    return md


def export_to_file(project_name: Optional[str], output_path: str):
    """ëŒ€ì‹œë³´ë“œë¥¼ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°"""
    if project_name:
        content = generate_dashboard_markdown(project_name)
    else:
        content = generate_summary_dashboard()

    with open(output_path, "w", encoding="utf-8") as f:
        f.write(content)

    print(f"Dashboard exported to: {output_path}")


def print_notion_instructions(project_name: Optional[str] = None):
    """Notion ì—…ë°ì´íŠ¸ ë°©ë²• ì•ˆë‚´"""
    if project_name:
        content = generate_dashboard_markdown(project_name)
    else:
        content = generate_summary_dashboard()

    print("=" * 60)
    print("NOTION DASHBOARD CONTENT")
    print("=" * 60)
    print()
    print("Claude Codeì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ Notionì— ì—…ë°ì´íŠ¸:")
    print()
    print('1. ê¸°ì¡´ í˜ì´ì§€ ì—…ë°ì´íŠ¸:')
    print('   mcp__notion__notion-update-page ì‚¬ìš©')
    print()
    print('2. ìƒˆ í˜ì´ì§€ ìƒì„±:')
    print('   mcp__notion__notion-create-pages ì‚¬ìš©')
    print()
    print("=" * 60)
    print()
    print(content)


# CLI ì¸í„°í˜ì´ìŠ¤
if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: notion_dashboard.py <command> [args]")
        print("")
        print("Commands:")
        print("  show [project_name]      - ëŒ€ì‹œë³´ë“œ ì¶œë ¥ (ì „ì²´ ë˜ëŠ” íŠ¹ì • í”„ë¡œì íŠ¸)")
        print("  export <output_path> [project_name] - ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°")
        print("  notion [project_name]    - Notion ì—…ë°ì´íŠ¸ ì•ˆë‚´")
        print("  list                     - í”„ë¡œì íŠ¸ ëª©ë¡")
        print("")
        print("Example:")
        print("  python3 notion_dashboard.py show valley-v2")
        print("  python3 notion_dashboard.py export ./dashboard.md")
        sys.exit(1)

    cmd = sys.argv[1]

    if cmd == "list":
        projects = list_projects()
        if projects:
            print("Available projects:")
            for p in projects:
                print(f"  - {p}")
        else:
            print("No projects found.")

    elif cmd == "show":
        project_name = sys.argv[2] if len(sys.argv) > 2 else None
        if project_name:
            print(generate_dashboard_markdown(project_name))
        else:
            print(generate_summary_dashboard())

    elif cmd == "export" and len(sys.argv) > 2:
        output_path = sys.argv[2]
        project_name = sys.argv[3] if len(sys.argv) > 3 else None
        export_to_file(project_name, output_path)

    elif cmd == "notion":
        project_name = sys.argv[2] if len(sys.argv) > 2 else None
        print_notion_instructions(project_name)

    else:
        print(f"Unknown command: {cmd}")
        sys.exit(1)
